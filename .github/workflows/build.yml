name: Build system configurations

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      has-relevant-changes: ${{ steps.filter.outputs.has-relevant-changes }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 2
      - name: Check for relevant changes
        id: filter
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            files=$(git diff --name-only "${{ github.event.pull_request.base.sha }}..HEAD")
          else
            if git rev-parse HEAD^ >/dev/null 2>&1; then
              files=$(git diff --name-only HEAD^ HEAD)
            else
              files=$(git ls-files)
            fi
          fi

          if echo "$files" | grep -qE '\.(nix|lock)$|\.github/workflows/build\.yml'; then
            echo "has-relevant-changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has-relevant-changes=false" >> "$GITHUB_OUTPUT"
          fi

  prepare-matrix:
    needs: check-changes
    if: needs.check-changes.outputs.has-relevant-changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read

    outputs:
      matrix: ${{ steps.create-matrix.outputs.matrix }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Nix
        uses: ./.github/actions/setup-nix
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create matrix
        id: create-matrix
        run: |
          matrix_json=$(jq -n '[]')

          nixos_hosts=$(nix eval --json '.#nixosConfigurations' --apply 'x: builtins.attrNames x' 2>/dev/null || echo '[]')
          for host in $(echo "$nixos_hosts" | jq -r '.[]'); do
            system=$(nix eval --raw ".#nixosConfigurations.$host.config.nixpkgs.system" 2>/dev/null || echo "")
            case "$system" in
              aarch64-linux)
                runner="ubuntu-24.04-arm"
                ;;
              x86_64-linux)
                runner="ubuntu-latest"
                ;;
              *)
                echo "::warning::Skipping unsupported system: $system for $host"
                continue
                ;;
            esac
            matrix_json=$(echo "$matrix_json" | jq --arg host "$host" --arg system "$system" --arg runner "$runner" --arg config "nixosConfigurations" \
              '. += [{"hostname": $host, "system": $system, "runner": $runner, "config": $config}]')
          done

          darwin_hosts=$(nix eval --json '.#darwinConfigurations' --apply 'x: builtins.attrNames x' 2>/dev/null || echo '[]')
          for host in $(echo "$darwin_hosts" | jq -r '.[]'); do
            system=$(nix eval --raw ".#darwinConfigurations.$host.config.nixpkgs.system" 2>/dev/null || echo "")
            case "$system" in
              aarch64-darwin)
                runner="macos-latest"
                ;;
              x86_64-darwin)
                runner="macos-13"
                ;;
              *)
                echo "::warning::Skipping unsupported system: $system for $host"
                continue
                ;;
            esac
            matrix_json=$(echo "$matrix_json" | jq --arg host "$host" --arg system "$system" --arg runner "$runner" --arg config "darwinConfigurations" \
              '. += [{"hostname": $host, "system": $system, "runner": $runner, "config": $config}]')
          done

          total=$(echo "$matrix_json" | jq 'length')
          if [ "$total" -eq 0 ]; then
            echo "::error::No valid system configurations found. Check flake outputs."
            exit 1
          fi

          echo "matrix=$(echo "$matrix_json" | jq -c .)" >> "$GITHUB_OUTPUT"
          echo "::notice::Detected $total system configuration(s)"

  build:
    needs: [check-changes, prepare-matrix]
    if: needs.check-changes.outputs.has-relevant-changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    name: ${{ matrix.hostname }} [${{ matrix.system }}]
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 60
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Nix
        uses: ./.github/actions/setup-nix
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build System
        run: |
          echo "::notice::Building configuration for ${{ matrix.hostname }}..."
          nix build --print-build-logs .#${{ matrix.config }}.${{ matrix.hostname }}.config.system.build.toplevel

  all-builds-pass:
    needs: [build]
    if: always()
    name: All builds pass
    uses: ./.github/workflows/status-check.yml
    with:
      job-name: Build
      needs-result: ${{ needs.build.result }}
